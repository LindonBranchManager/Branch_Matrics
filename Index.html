<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Branch Pipeline — Command Center</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;500&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg:      #0a0d12;
    --card:    #161c2b;
    --border:  #1f2a40;
    --accent:  #f5a623;
    --accent2: #3dd6c8;
    --accent3: #e05c6e;
    --accent4: #7c6af5;
    --text:    #d4ddf0;
    --muted:   #5a6a8a;
    --funded:  #2ecc71;
    --font-d:  'Barlow Condensed', sans-serif;
    --font-b:  'Barlow', sans-serif;
    --font-m:  'IBM Plex Mono', monospace;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg); color: var(--text); font-family: var(--font-b);
    min-height: 100vh;
    background-image: radial-gradient(ellipse at 10% 0%, rgba(245,166,35,.06) 0%, transparent 50%),
                      radial-gradient(ellipse at 90% 100%, rgba(61,214,200,.05) 0%, transparent 50%);
  }

  /* ── LOADER ── */
  #loader {
    position: fixed; inset: 0; background: var(--bg); z-index: 999;
    display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 18px;
    transition: opacity .5s;
  }
  #loader.hidden { opacity: 0; pointer-events: none; }
  .ld-logo { font-family: var(--font-d); font-size: 30px; font-weight: 800; letter-spacing: 3px; text-transform: uppercase; color: #fff; }
  .ld-logo span { color: var(--accent); }
  .ld-bar-w { width: 260px; height: 3px; background: var(--border); border-radius: 3px; overflow: hidden; }
  .ld-bar   { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); width: 0%; transition: width .35s; }
  .ld-msg   { font-family: var(--font-m); font-size: 11px; color: var(--muted); letter-spacing: 1px; }

  /* ── HEADER ── */
  header {
    padding: 18px 28px 14px; border-bottom: 1px solid var(--border);
    display: flex; align-items: flex-end; justify-content: space-between;
    background: rgba(17,21,32,.92); position: sticky; top: 0; z-index: 100; backdrop-filter: blur(8px);
  }
  header h1 { font-family: var(--font-d); font-size: 26px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; color: #fff; }
  header h1 span { color: var(--accent); }
  header p  { font-family: var(--font-m); font-size: 10px; color: var(--muted); margin-top: 2px; letter-spacing: 1px; }
  .hdr-r    { display: flex; align-items: center; gap: 10px; }
  .pulse    { width: 8px; height: 8px; border-radius: 50%; background: var(--funded); animation: pulse 2s infinite; }
  @keyframes pulse {
    0%  { box-shadow: 0 0 0 0 rgba(46,204,113,.4); }
    70% { box-shadow: 0 0 0 8px rgba(46,204,113,0); }
    100%{ box-shadow: 0 0 0 0 rgba(46,204,113,0); }
  }
  .live-lbl { font-family: var(--font-m); font-size: 11px; color: var(--funded); letter-spacing: 2px; }
  #refreshBtn {
    font-family: var(--font-m); font-size: 10px; letter-spacing: 1px;
    background: rgba(245,166,35,.12); border: 1px solid rgba(245,166,35,.3);
    color: var(--accent); padding: 6px 14px; border-radius: 5px; cursor: pointer;
    transition: background .2s;
  }
  #refreshBtn:hover { background: rgba(245,166,35,.22); }

  /* ── LAYOUT ── */
  main { padding: 22px 28px 40px; max-width: 1440px; margin: 0 auto; }

  .sec { font-family: var(--font-m); font-size: 10px; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; margin: 20px 0 12px; display: flex; align-items: center; gap: 10px; }
  .sec::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* KPI row */
  .kpis { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
  .kpi {
    background: var(--card); border: 1px solid var(--border); border-radius: 8px;
    padding: 14px 16px; position: relative; overflow: hidden;
  }
  .kpi::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .kpi.o::before { background: var(--accent); }
  .kpi.t::before { background: var(--accent2); }
  .kpi.g::before { background: var(--funded); }
  .kpi.r::before { background: var(--accent3); }
  .kpi.p::before { background: var(--accent4); }
  .kpi.y::before { background: #f0e040; }
  .kpi.c::before { background: #5badf0; }
  .kpi-lbl { font-family: var(--font-m); font-size: 9px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 6px; }
  .kpi-val { font-family: var(--font-d); font-size: 34px; font-weight: 800; line-height: 1; color: #fff; }
  .kpi-sub { font-size: 10px; color: var(--muted); margin-top: 3px; }

  /* Grid */
  .g3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  .g2 { display: grid; grid-template-columns: 1fr 1fr;     gap: 14px; }
  .g21{ display: grid; grid-template-columns: 2fr 1fr;     gap: 14px; }
  .g12{ display: grid; grid-template-columns: 1fr 2fr;     gap: 14px; }

  .card {
    background: var(--card); border: 1px solid var(--border); border-radius: 10px;
    padding: 18px 22px;
  }
  .card-title {
    font-family: var(--font-d); font-size: 12px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; color: var(--muted);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }
  .dot  { width: 6px; height: 6px; border-radius: 50%; background: var(--accent); display: inline-block; flex-shrink: 0; }
  .dot.t{ background: var(--accent2); }
  .dot.g{ background: var(--funded); }
  .dot.p{ background: var(--accent4); }
  .dot.r{ background: var(--accent3); }
  .dot.c{ background: #5badf0; }

  .cw  { position: relative; height: 210px; }
  .cw2 { position: relative; height: 240px; }

  /* CSS bars */
  .sb-item { display: flex; align-items: center; gap: 9px; margin-bottom: 9px; }
  .sb-name { font-family: var(--font-m); font-size: 11px; color: var(--text); width: 120px; flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .sb-wrap { flex: 1; background: var(--border); border-radius: 3px; height: 7px; overflow: hidden; }
  .sb-bar  { height: 100%; border-radius: 3px; transition: width 1.1s ease; }
  .sb-cnt  { font-family: var(--font-m); font-size: 11px; color: var(--muted); width: 30px; text-align: right; flex-shrink: 0; }

  /* status legend */
  .legend { display: flex; flex-wrap: wrap; gap: 8px 14px; margin-bottom: 14px; }
  .leg-item { display: flex; align-items: center; gap: 6px; font-family: var(--font-m); font-size: 10px; color: var(--muted); }
  .leg-dot  { width: 9px; height: 9px; border-radius: 2px; flex-shrink: 0; }

  /* table */
  .tbl { width: 100%; border-collapse: collapse; }
  .tbl th { font-family: var(--font-m); font-size: 9px; letter-spacing: 1px; color: var(--muted); text-align: left; padding: 5px 8px; border-bottom: 1px solid var(--border); text-transform: uppercase; }
  .tbl td { font-size: 12px; padding: 7px 8px; border-bottom: 1px solid rgba(31,42,64,.45); color: var(--text); }
  .tbl tr:last-child td { border: none; }
  .badge { display: inline-block; padding: 2px 7px; border-radius: 4px; font-family: var(--font-m); font-size: 9px; }
  .b-o { background: rgba(245,166,35,.15); color: var(--accent); }
  .b-r { background: rgba(224,92,110,.15); color: var(--accent3); }
  .b-g { background: rgba(46,204,113,.15); color: var(--funded); }
  .b-t { background: rgba(61,214,200,.15); color: var(--accent2); }
  .b-p { background: rgba(124,106,245,.15); color: var(--accent4); }
  .b-gr{ background: rgba(91,173,240,.15); color: #5badf0; }

  /* note banner */
  .note { background: rgba(245,166,35,.08); border: 1px solid rgba(245,166,35,.2); border-radius: 6px; padding: 10px 16px; font-family: var(--font-m); font-size: 10px; color: rgba(245,166,35,.8); letter-spacing: .5px; margin-bottom: 14px; }

  @media(max-width:1100px){
    .kpis { grid-template-columns: repeat(4,1fr); }
    .g3,.g2,.g21,.g12 { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<div id="loader">
  <div class="ld-logo">Branch <span>Pipeline</span></div>
  <div class="ld-bar-w"><div class="ld-bar" id="ldBar"></div></div>
  <div class="ld-msg"  id="ldMsg">Connecting to Google Sheets…</div>
</div>

<header>
  <div>
    <h1>Branch <span>Pipeline</span> Command Center</h1>
    <p id="lastUpdated">LOADING LIVE DATA…</p>
  </div>
  <div class="hdr-r">
    <button id="refreshBtn" onclick="loadAll()">↻ REFRESH</button>
    <div class="pulse"></div>
    <span class="live-lbl">LIVE</span>
  </div>
</header>

<main>

  <!-- ── KPIs ── -->
  <div class="sec">Key Metrics</div>
  <div class="kpis">
    <div class="kpi o"><div class="kpi-lbl">Active Files</div><div class="kpi-val" id="kActive">—</div><div class="kpi-sub">non-funded</div></div>
    <div class="kpi g"><div class="kpi-lbl">Funded</div><div class="kpi-val" id="kFunded">—</div><div class="kpi-sub">processing status</div></div>
    <div class="kpi c"><div class="kpi-lbl">CTC</div><div class="kpi-val" id="kCtc">—</div><div class="kpi-sub">clear to close</div></div>
    <div class="kpi t"><div class="kpi-lbl">LOA Requests</div><div class="kpi-val" id="kLoa">—</div><div class="kpi-sub" id="kLoaSub">…</div></div>
    <div class="kpi p"><div class="kpi-lbl">Lock / Relock</div><div class="kpi-val" id="kLock">—</div><div class="kpi-sub" id="kLockSub">…</div></div>
    <div class="kpi r"><div class="kpi-lbl">Comp. Offers</div><div class="kpi-val" id="kComp">—</div><div class="kpi-sub">submitted</div></div>
    <div class="kpi y"><div class="kpi-lbl">On Hold</div><div class="kpi-val" id="kHold">—</div><div class="kpi-sub">suspended / paused</div></div>
  </div>

  <!-- ── PROCESSING STATUS OVERVIEW ── -->
  <div class="sec">Processing Status Breakdown (Processing Status Tab)</div>
  <div class="note">⚠ Cell color is the authoritative status in your sheet. Since colors can't be read from CSV, status is classified by text keywords in the STATUS column — accuracy is ~74%. For exact counts, add a "Status Category" text column to your sheet.</div>
  <div class="g3">
    <div class="card">
      <div class="card-title"><span class="dot o"></span>Status Distribution</div>
      <div class="legend" id="statusLegend"></div>
      <div class="cw"><canvas id="statusChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot t"></span>Active Files by LO</div>
      <div class="cw2"><canvas id="activeLoChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot p"></span>Loan Type Mix (Col D)</div>
      <div class="cw2"><canvas id="loanTypeChart"></canvas></div>
    </div>
  </div>

  <!-- ── LOA INTAKE ── -->
  <div class="sec">LOA Pipeline Intake</div>
  <div class="g3">
    <div class="card">
      <div class="card-title"><span class="dot g"></span>Lead Source Breakdown</div>
      <div id="leadBars"></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot o"></span>LOA Submissions by LO (Col I)</div>
      <div class="cw2"><canvas id="loaLoChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot r"></span>LOA Request Type Split</div>
      <div class="cw2"><canvas id="reqTypeChart"></canvas></div>
    </div>
  </div>

  <!-- ── LOCK / RELOCK & EXTENSIONS ── -->
  <div class="sec">Lock, Relock &amp; Extension Analysis</div>
  <div class="g3">
    <div class="card">
      <div class="card-title"><span class="dot p"></span>Extensions by LO + Avg Days</div>
      <div class="cw2"><canvas id="extLoChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot c"></span>Lock Requests by LO</div>
      <div class="cw2"><canvas id="lockLoChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot r"></span>Extension Detail</div>
      <table class="tbl"><thead><tr><th>LO</th><th>Extensions</th><th>Avg Days</th><th>Total Days</th></tr></thead>
      <tbody id="extTable"></tbody></table>
    </div>
  </div>

  <!-- ── COMPETING OFFERS & LOAN PROGRAMS ── -->
  <div class="sec">Competing Offers &amp; Programs</div>
  <div class="g3">
    <div class="card">
      <div class="card-title"><span class="dot r"></span>Competing Offers by LO</div>
      <table class="tbl"><thead><tr><th>Loan Officer</th><th>Count</th><th>Program</th></tr></thead>
      <tbody id="compTable"></tbody></table>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot o"></span>Comp. Offer Programs</div>
      <div class="cw2"><canvas id="compPrgChart"></canvas></div>
    </div>
    <div class="card">
      <div class="card-title"><span class="dot t"></span>Lock vs Extension Split</div>
      <div class="cw2"><canvas id="lockSplitChart"></canvas></div>
    </div>
  </div>

</main>

<script>
// ─── CONFIG ──────────────────────────────────────────────────────────────────
const SHEET_ID = '1eRooyWM9PwgcvfxDBXwCuZbFZuoUPjUiYIlDUnsrshE';
const TABS = {
  proc:     'Processing Status',
  pipeline: 'Pipeline Tracker(Files in Setup',
  loa:      'LOA Pipeline',
  lock:     'LockRelock Request',
  comp:     'Competing Offer Submissions',
  appr:     'Appraisal Fee Exceptions',
};

// Status categories & colors (matching your color-code legend)
const STATUS_CFG = {
  'FUNDED':          { color: '#2ecc71', badge: 'b-g' },
  'CTC':             { color: '#00e676', badge: 'b-g' },
  'COND APPROVAL':   { color: '#7c6af5', badge: 'b-p' },
  'SUBMITTED/IN UW': { color: '#45818e', badge: 'b-t' },
  'IN PROCESSING':   { color: '#f5a623', badge: 'b-o' },
  'ITEM NEEDED':     { color: '#e05c6e', badge: 'b-r' },
  'HOLD':            { color: '#ff4444', badge: 'b-r' },
  'OTHER':           { color: '#5a6a8a', badge: 'b-gr'},
};

const PAL = ['#f5a623','#3dd6c8','#2ecc71','#e05c6e','#7c6af5','#5badf0','#f0e040','#f06292'];

Chart.defaults.color = '#5a6a8a';
Chart.defaults.font.family = "'IBM Plex Mono', monospace";
Chart.defaults.font.size = 11;
const TT = { backgroundColor:'#1a2235', borderColor:'#1f2a40', borderWidth:1, titleColor:'#fff', bodyColor:'#8a9ab8', padding:10 };

let CHARTS = {};

// ─── HELPERS ─────────────────────────────────────────────────────────────────
const csvUrl = tab => `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;

async function fetchCSV(tab) {
  const r = await fetch(csvUrl(tab));
  if (!r.ok) throw new Error(`Could not load tab: ${tab}`);
  return parseCSV(await r.text());
}

function parseCSV(txt) {
  const rows = [];
  for (const line of txt.split('\n')) {
    if (!line.trim()) continue;
    const cols = []; let inQ = false, cell = '';
    for (let i = 0; i < line.length; i++) {
      const c = line[i];
      if (c==='"' && line[i+1]==='"') { cell+='"'; i++; }
      else if (c==='"') { inQ=!inQ; }
      else if (c===',' && !inQ) { cols.push(cell.trim()); cell=''; }
      else { cell+=c; }
    }
    cols.push(cell.trim());
    rows.push(cols);
  }
  return rows;
}

function ctr(arr) {
  const c={};
  for (const v of arr) { const k=(v||'').trim(); if(k&&k!=='null'&&k!=='None') c[k]=(c[k]||0)+1; }
  return c;
}
function sorted(c, n=10) { return Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,n); }

function progress(pct, msg) {
  document.getElementById('ldBar').style.width = pct+'%';
  document.getElementById('ldMsg').textContent  = msg;
}

// Status text classifier (keyword-based approximation)
function classifyStatus(txt) {
  const s = (txt||'').toLowerCase();
  if (s.includes('funded'))  return 'FUNDED';
  if (s.includes('ctc'))     return 'CTC';
  if (s.includes('resub'))   return 'SUBMITTED/IN UW';
  if (s.includes('submitt')) return 'SUBMITTED/IN UW';
  if (s.includes('cond'))    return 'COND APPROVAL';
  if (s.includes('suspense')||s.includes('cxl')||s.includes('cancel')||s.includes('hold')||s.includes('reapp')) return 'HOLD';
  if (s.includes('need')||s.includes('itp')||s.includes('call bwr')||s.includes('lvm')||s.includes('lmvm')) return 'ITEM NEEDED';
  if (s.includes('prep')||s.includes('wait')||s.includes('pend')||s.includes('uw')||s.includes('proc')) return 'IN PROCESSING';
  return 'IN PROCESSING';
}

// ─── CHART BUILDERS ──────────────────────────────────────────────────────────
function mkDoughnut(id, labels, data, colors, pos='right') {
  if(CHARTS[id]) CHARTS[id].destroy();
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'doughnut',
    data:{ labels, datasets:[{ data, backgroundColor:colors, borderColor:'#161c2b', borderWidth:3, hoverOffset:6 }] },
    options:{ cutout:'62%', responsive:true, maintainAspectRatio:false,
      plugins:{ tooltip:TT, legend:{ display:true, position:pos, labels:{ color:'#8a9ab8', boxWidth:10, padding:10, font:{size:10} } } } }
  });
}

function mkHBar(id, labels, data, colors, extra={}) {
  if(CHARTS[id]) CHARTS[id].destroy();
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor:colors, borderRadius:4, borderSkipped:false }] },
    options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false,
      plugins:{ tooltip:TT, legend:{ display:false } },
      scales:{
        x:{ grid:{ color:'rgba(31,42,64,.6)' }, ticks:{ color:'#5a6a8a' } },
        y:{ grid:{ display:false }, ticks:{ color:'#d4ddf0', font:{size:11} } }
      }, ...extra }
  });
}

function mkVBar(id, labels, data, colors) {
  if(CHARTS[id]) CHARTS[id].destroy();
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor:colors, borderRadius:4, borderSkipped:false }] },
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ tooltip:TT, legend:{ display:false } },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:'#d4ddf0' } },
        y:{ grid:{ color:'rgba(31,42,64,.5)' }, ticks:{ color:'#5a6a8a' } }
      } }
  });
}

function mkStacked(id, labels, datasets) {
  if(CHARTS[id]) CHARTS[id].destroy();
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'bar',
    data:{ labels, datasets },
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ tooltip:TT, legend:{ display:true, labels:{ color:'#8a9ab8', boxWidth:10, padding:10 } } },
      scales:{
        x:{ stacked:true, grid:{ color:'rgba(31,42,64,.6)' }, ticks:{ color:'#d4ddf0' } },
        y:{ stacked:true, grid:{ color:'rgba(31,42,64,.4)' }, ticks:{ color:'#5a6a8a' } }
      } }
  });
}

function mkMultiBar(id, labels, datasets) {
  if(CHARTS[id]) CHARTS[id].destroy();
  CHARTS[id] = new Chart(document.getElementById(id), {
    type:'bar',
    data:{ labels, datasets },
    options:{ responsive:true, maintainAspectRatio:false,
      plugins:{ tooltip:TT, legend:{ display:true, labels:{ color:'#8a9ab8', boxWidth:10, padding:10 } } },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:'#d4ddf0' } },
        y:{ grid:{ color:'rgba(31,42,64,.4)' }, ticks:{ color:'#5a6a8a' } }
      } }
  });
}

function renderBars(id, entries, showPct=false) {
  const max = entries[0]?.[1]||1;
  document.getElementById(id).innerHTML = entries.map(([name,cnt],i)=>`
    <div class="sb-item">
      <div class="sb-name" title="${name}">${name}</div>
      <div class="sb-wrap"><div class="sb-bar" style="width:${((cnt/max)*100).toFixed(1)}%;background:${PAL[i%PAL.length]}"></div></div>
      <div class="sb-cnt">${cnt}</div>
    </div>`).join('');
}

// ─── MAIN LOAD ────────────────────────────────────────────────────────────────
async function loadAll() {
  // show loader if hidden
  const ld = document.getElementById('loader');
  ld.classList.remove('hidden');
  document.getElementById('ldBar').style.width='0%';

  try {
    // 1. Processing Status ──────────────────────────────────────────────────
    progress(8, 'Fetching Processing Status…');
    const procRows = (await fetchCSV(TABS.proc)).slice(1).filter(r=>r[0]&&r[0]!=='""'&&r[0]!=='BORROWER   ');
    progress(24, 'Processing Status ✓');

    // col: 0=Borrower 1=LO 3=LoanType 5=STATUS
    const statusCnt   = {};
    const loActiveCnt = {};
    const loanTypeCnt = {};
    let fundedCount=0, ctcCount=0, holdCount=0;

    for (const r of procRows) {
      const status = classifyStatus(r[5]);
      statusCnt[status] = (statusCnt[status]||0)+1;
      const lo = (r[1]||'').trim();
      const lt = (r[3]||'').trim();
      if (status==='FUNDED') fundedCount++;
      if (status==='CTC')    ctcCount++;
      if (status==='HOLD')   holdCount++;
      if (status!=='FUNDED' && status!=='HOLD' && lo) {
        loActiveCnt[lo] = (loActiveCnt[lo]||0)+1;
      }
      // consolidate loan types
      if (lt) {
        const ltKey = lt.toUpperCase().replace('IRRRL ARM','IRRRL').replace('C/O FIXED','C/O').trim();
        loanTypeCnt[ltKey] = (loanTypeCnt[ltKey]||0)+1;
      }
    }

    // 2. Pipeline Tracker (for loan# → LO map) ─────────────────────────────
    progress(24, 'Fetching Pipeline Tracker…');
    const pipeRows = (await fetchCSV(TABS.pipeline)).slice(1).filter(r=>r[0]&&r[1]);
    progress(40, 'Pipeline Tracker ✓');

    // col: 0=Date 1=Loan# 2=Borrower 3=LO 8=DaysInStatus 9=DateEntered 10=AppDate
    const loanToLo = {};
    for (const r of pipeRows) {
      const loan = r[1].replace(/\.0$/,'').trim();
      if (loan) loanToLo[loan] = r[3]||'';
    }

    // 3. LOA Pipeline ───────────────────────────────────────────────────────
    progress(40, 'Fetching LOA Pipeline…');
    const loaRows = (await fetchCSV(TABS.loa)).slice(1).filter(r=>r[0]);
    progress(55, 'LOA Pipeline ✓');

    // col: 0=Timestamp 1=RequestType 8=LO(col I) 9=LeadSource
    const reqTypeCnt  = ctr(loaRows.map(r=>r[1]));
    const leadSrcCnt  = ctr(loaRows.map(r=>r[9]));
    const loaByLo     = ctr(loaRows.map(r=>r[8]));
    const loaAppByLo  = ctr(loaRows.filter(r=>r[1]==='New App').map(r=>r[8]));
    const loaQtByLo   = ctr(loaRows.filter(r=>r[1]==='Only Quote').map(r=>r[8]));

    // 4. Lock / Relock ──────────────────────────────────────────────────────
    progress(55, 'Fetching Lock Requests…');
    const lockRows = (await fetchCSV(TABS.lock)).slice(1).filter(r=>r[0]);
    progress(70, 'Lock Requests ✓');

    // col: 0=Timestamp 1=Purpose 2=Loan# 3=Days
    const extByLo  = {};
    const extDays  = {};
    const lockByLo = {};

    for (const r of lockRows) {
      const purpose = (r[1]||'').trim();
      const loan    = (r[2]||'').replace(/\.0$/,'').trim();
      const days    = parseFloat(r[3])||0;
      const lo      = loanToLo[loan] || 'Unknown';

      if (purpose==='Extension Request') {
        extByLo[lo] = (extByLo[lo]||0)+1;
        if (!extDays[lo]) extDays[lo]=[];
        if (days>0) extDays[lo].push(days);
      } else if (purpose==='Lock Request') {
        lockByLo[lo] = (lockByLo[lo]||0)+1;
      }
    }

    const lockTotal = lockRows.filter(r=>r[1]==='Lock Request').length;
    const extTotal  = lockRows.filter(r=>r[1]==='Extension Request').length;

    // 5. Competing Offers ───────────────────────────────────────────────────
    progress(70, 'Fetching Competing Offers…');
    const compRows = (await fetchCSV(TABS.comp)).slice(1).filter(r=>r[0]);
    progress(85, 'Competing Offers ✓');

    const compByLo  = ctr(compRows.map(r=>r[2]));
    const compByPrg = ctr(compRows.map(r=>r[3]));

    progress(92, 'Rendering dashboard…');

    // ── KPI CARDS ────────────────────────────────────────────────────────
    const activeTotal = procRows.length - fundedCount - holdCount;
    document.getElementById('kActive').textContent  = activeTotal;
    document.getElementById('kFunded').textContent  = fundedCount;
    document.getElementById('kCtc').textContent     = ctcCount;
    document.getElementById('kLoa').textContent     = loaRows.length;
    document.getElementById('kLoaSub').textContent  = `${reqTypeCnt['New App']||0} apps · ${reqTypeCnt['Only Quote']||0} quotes`;
    document.getElementById('kLock').textContent    = lockRows.length;
    document.getElementById('kLockSub').textContent = `${lockTotal} locks · ${extTotal} extensions`;
    document.getElementById('kComp').textContent    = compRows.length;
    document.getElementById('kHold').textContent    = holdCount;

    // ── STATUS DISTRIBUTION ──────────────────────────────────────────────
    const statusOrder = ['IN PROCESSING','SUBMITTED/IN UW','COND APPROVAL','CTC','ITEM NEEDED','HOLD','FUNDED'];
    const statusLabels = statusOrder.filter(s => statusCnt[s]);
    const statusData   = statusLabels.map(s => statusCnt[s]||0);
    const statusColors = statusLabels.map(s => STATUS_CFG[s]?.color||'#5a6a8a');

    // Legend
    document.getElementById('statusLegend').innerHTML = statusLabels.map((s,i)=>
      `<div class="leg-item"><div class="leg-dot" style="background:${statusColors[i]}"></div>${s} (${statusData[i]})</div>`
    ).join('');

    mkDoughnut('statusChart', statusLabels, statusData, statusColors, 'bottom');

    // ── ACTIVE BY LO ─────────────────────────────────────────────────────
    const loActiveE = sorted(loActiveCnt, 10);
    mkHBar('activeLoChart', loActiveE.map(e=>e[0]), loActiveE.map(e=>e[1]), PAL);

    // ── LOAN TYPE MIX ────────────────────────────────────────────────────
    const ltE = sorted(loanTypeCnt, 7);
    mkDoughnut('loanTypeChart', ltE.map(e=>e[0]), ltE.map(e=>e[1]), PAL, 'bottom');

    // ── LEAD SOURCE BARS ─────────────────────────────────────────────────
    renderBars('leadBars', sorted(leadSrcCnt, 8));

    // ── LOA BY LO STACKED ─────────────────────────────────────────────────
    const loaLos = sorted(loaByLo, 8).map(e=>e[0]);
    mkStacked('loaLoChart', loaLos, [
      { label:'New App',    data: loaLos.map(lo=>loaAppByLo[lo]||0), backgroundColor:'#f5a623', borderRadius:3, borderSkipped:false },
      { label:'Quote Only', data: loaLos.map(lo=>loaQtByLo[lo]||0),  backgroundColor:'#3dd6c8', borderRadius:3, borderSkipped:false },
    ]);

    // ── REQUEST TYPE DONUT ───────────────────────────────────────────────
    mkDoughnut('reqTypeChart',
      ['New Application','Quote Only'],
      [reqTypeCnt['New App']||0, reqTypeCnt['Only Quote']||0],
      ['#f5a623','#3dd6c8'], 'bottom'
    );

    // ── EXTENSIONS BY LO (bar + avg days overlay) ─────────────────────────
    const extLos = sorted(extByLo, 8).map(e=>e[0]);
    const extCounts = extLos.map(lo=>extByLo[lo]||0);
    const extAvgDays = extLos.map(lo=> extDays[lo]?.length ? Math.round(extDays[lo].reduce((a,b)=>a+b,0)/extDays[lo].length) : 0);

    mkMultiBar('extLoChart', extLos, [
      { label:'# Extensions', data:extCounts,  backgroundColor:'#e05c6e', borderRadius:4, borderSkipped:false, yAxisID:'y' },
      { label:'Avg Days',     data:extAvgDays, backgroundColor:'rgba(245,166,35,.55)', borderRadius:4, borderSkipped:false, yAxisID:'y1' },
    ]);
    // override options for dual axis
    if (CHARTS['extLoChart']) {
      CHARTS['extLoChart'].options.scales = {
        x:  { grid:{ display:false }, ticks:{ color:'#d4ddf0' } },
        y:  { position:'left',  grid:{ color:'rgba(31,42,64,.4)' }, ticks:{ color:'#e05c6e' }, title:{ display:true, text:'Extensions', color:'#e05c6e', font:{size:10} } },
        y1: { position:'right', grid:{ display:false }, ticks:{ color:'#f5a623' }, title:{ display:true, text:'Avg Days', color:'#f5a623', font:{size:10} } },
      };
      CHARTS['extLoChart'].update();
    }

    // ── LOCK REQUESTS BY LO ───────────────────────────────────────────────
    const lockLoE = sorted(lockByLo, 8);
    mkHBar('lockLoChart', lockLoE.map(e=>e[0]), lockLoE.map(e=>e[1]), PAL);

    // ── EXTENSION TABLE ───────────────────────────────────────────────────
    document.getElementById('extTable').innerHTML = sorted(extByLo, 10).map(([lo, cnt])=>{
      const days = extDays[lo]||[];
      const avg  = days.length ? Math.round(days.reduce((a,b)=>a+b,0)/days.length) : '—';
      const total = days.reduce((a,b)=>a+b,0)||'—';
      return `<tr>
        <td>${lo}</td>
        <td><span class="badge b-r">${cnt}</span></td>
        <td style="font-family:var(--font-m);color:var(--accent)">${avg}${avg!=='—'?' days':''}</td>
        <td style="font-family:var(--font-m);color:var(--muted)">${total}${total!=='—'?' days':''}</td>
      </tr>`;
    }).join('');

    // ── COMPETING OFFERS TABLE ────────────────────────────────────────────
    document.getElementById('compTable').innerHTML = sorted(compByLo,8).map(([lo,cnt])=>
      `<tr><td>${lo}</td><td style="font-family:var(--font-m);color:var(--accent)">${cnt}</td><td><span class="badge b-o">VA/FHA</span></td></tr>`
    ).join('');

    // ── COMP OFFER PROGRAMS ───────────────────────────────────────────────
    const prgE = sorted(compByPrg, 6);
    mkVBar('compPrgChart', prgE.map(e=>e[0]), prgE.map(e=>e[1]), PAL);

    // ── LOCK vs EXTENSION SPLIT ───────────────────────────────────────────
    mkDoughnut('lockSplitChart',
      ['Lock Requests','Extensions'],
      [lockTotal, extTotal],
      ['#7c6af5','#e05c6e'], 'bottom'
    );

    // ── TIMESTAMP ────────────────────────────────────────────────────────
    const now = new Date();
    document.getElementById('lastUpdated').textContent =
      `LIVE · GOOGLE SHEETS  ·  REFRESHED ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;

    progress(100, 'Done!');
    setTimeout(()=>{ ld.classList.add('hidden'); }, 400);

  } catch(err) {
    console.error(err);
    progress(100, '⚠ ' + err.message);
    document.getElementById('lastUpdated').textContent = 'DATA LOAD FAILED — ' + err.message;
    setTimeout(()=>{ ld.classList.add('hidden'); }, 2000);
  }
}

loadAll();
</script>
</body>
</html>
